name: ğŸš¦ Quality Gates

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  quality-check:
    name: ğŸ›¡ï¸ Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ” TypeScript check
      run: npm run typecheck
      
    - name: ğŸ§¹ Lint check
      run: npm run lint
      
    - name: ğŸ§ª Test coverage gate
      run: |
        npm run test:coverage
        # Check if coverage file exists and get coverage percentage
        if [ -f "coverage/coverage-summary.json" ]; then
          COVERAGE=$(node -p "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct")
          echo "Coverage: $COVERAGE%"
          if [ $(echo "$COVERAGE < 80" | bc -l 2>/dev/null || echo "0") -eq 1 ]; then
            echo "âŒ Coverage too low: $COVERAGE% (minimum 80%)"
            exit 1
          fi
          echo "âœ… Coverage meets requirements: $COVERAGE%"
        else
          echo "âš ï¸ Coverage file not found, skipping coverage gate"
        fi
      
    - name: ğŸ—ï¸ Build check
      run: npm run build
      
    - name: ğŸ“Š Bundle size check
      run: |
        if [ -d "dist" ]; then
          SIZE=$(du -sk dist 2>/dev/null | cut -f1 || echo "0")
          echo "Bundle size: ${SIZE}KB"
          # Fail if bundle is over 2MB (2048KB)
          if [ $SIZE -gt 2048 ]; then
            echo "âŒ Bundle too large: ${SIZE}KB (maximum 2048KB)"
            exit 1
          fi
          echo "âœ… Bundle size acceptable: ${SIZE}KB"
        else
          echo "âš ï¸ Build directory not found, skipping size check"
        fi
        
    - name: ğŸ”’ Security check
      run: |
        npm audit --audit-level high
        echo "âœ… No high-severity vulnerabilities found"
        
    - name: âœ… Quality gates passed
      run: |
        echo "# ğŸ‰ All Quality Gates Passed!" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… TypeScript compilation" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ESLint rules" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Test coverage â‰¥80%" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Build successful" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Bundle size â‰¤2MB" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Security audit" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸš€ Ready to merge!" >> $GITHUB_STEP_SUMMARY