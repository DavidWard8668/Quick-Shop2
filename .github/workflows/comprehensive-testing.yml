name: ğŸ§ª Comprehensive Testing & Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run comprehensive overnight testing at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  # ğŸŒ Web App Testing
  web-testing:
    name: ğŸŒ Web App Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ” TypeScript type checking
      run: npm run typecheck
      
    - name: ğŸ§¹ ESLint code quality
      run: npm run lint
      
    - name: ğŸ—ï¸ Build application
      run: npm run build
      
    - name: ğŸ§ª Run unit tests
      run: npm run test:run
      
    - name: ğŸ“Š Generate test coverage
      run: npm run test:coverage
      
    - name: ğŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage/lcov.info
        
    - name: ğŸ’¾ Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: web-test-results
        path: |
          coverage/
          dist/

  # ğŸ iOS Testing
  ios-testing:
    name: ğŸ iOS App Tests
    runs-on: macos-latest
    needs: web-testing
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build web app
      run: npm run build
      
    - name: âš¡ Sync Capacitor
      run: npx cap sync ios
      
    - name: ğŸ”¨ Build iOS app
      run: xcodebuild -workspace ios/App/App.xcworkspace -scheme App -destination 'platform=iOS Simulator,name=iPhone 15' build
      
    - name: ğŸ§ª Run iOS tests
      run: xcodebuild test -workspace ios/App/App.xcworkspace -scheme App -destination 'platform=iOS Simulator,name=iPhone 15'
      continue-on-error: true
      
    - name: ğŸ’¾ Archive iOS build
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-build
        path: ios/

  # ğŸ¤– Android Testing
  android-testing:
    name: ğŸ¤– Android App Tests
    runs-on: ubuntu-latest
    needs: web-testing
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build web app
      run: npm run build
      
    - name: âš¡ Sync Capacitor
      run: npx cap sync android
      
    - name: ğŸ”¨ Build Android app
      run: |
        cd android
        ./gradlew assembleDebug
        
    - name: ğŸ§ª Run Android tests
      run: |
        cd android  
        ./gradlew testDebugUnitTest
      continue-on-error: true
      
    - name: ğŸ’¾ Archive Android build
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: android-build
        path: |
          android/app/build/outputs/
          android/app/build/reports/

  # ğŸ” Comprehensive Code Analysis
  code-analysis:
    name: ğŸ” Deep Code Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
        
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ”’ Security audit
      run: npm audit --audit-level high
      continue-on-error: true
      
    - name: ğŸ“Š Bundle size analysis
      run: |
        npm run build
        npx bundlemon --ci
      continue-on-error: true
      
    - name: ğŸ› SonarCloud scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      continue-on-error: true
        
    - name: ğŸ” CodeQL analysis
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        
    - name: ğŸ” Perform CodeQL analysis
      uses: github/codeql-action/analyze@v3
      
    - name: ğŸ“ Generate comprehensive report
      run: |
        echo "# ğŸ“Š Overnight Analysis Report - $(date)" > analysis-report.md
        echo "## ğŸ”’ Security Status" >> analysis-report-md
        npm audit --json > security-report.json || true
        echo "## ğŸ“¦ Bundle Analysis" >> analysis-report.md
        du -sh dist/ >> analysis-report.md
        echo "## ğŸ§ª Test Coverage" >> analysis-report.md
        npm run test:coverage --silent >> analysis-report.md || true
        
    - name: ğŸ’¾ Archive analysis results
      uses: actions/upload-artifact@v4
      with:
        name: overnight-analysis
        path: |
          analysis-report.md
          security-report.json
          coverage/

  # ğŸš€ Deployment Check
  deployment-check:
    name: ğŸš€ Deployment Verification
    runs-on: ubuntu-latest
    needs: [web-testing, ios-testing, android-testing]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Production build test
      run: npm run build
      
    - name: ğŸŒ Test deployment readiness
      run: |
        echo "âœ… Web build successful"
        echo "âœ… iOS build completed" 
        echo "âœ… Android build completed"
        echo "ğŸš€ Ready for deployment!"
        
    - name: ğŸ“Š Create deployment summary
      run: |
        echo "# ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Web tests passed" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… iOS build completed" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Android build completed" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ Ready for production deployment" >> $GITHUB_STEP_SUMMARY

  # ğŸ“± Mobile App Store Preparation (Manual trigger only)
  app-store-prep:
    name: ğŸ“± App Store Preparation
    runs-on: macos-latest
    if: github.event_name == 'workflow_dispatch'
    needs: [ios-testing, android-testing]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ Setup Xcode  
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: ğŸ“‹ Install dependencies
      run: npm ci
      
    - name: ğŸ—ï¸ Build web app
      run: npm run build
      
    - name: âš¡ Sync Capacitor
      run: |
        npx cap sync ios
        npx cap sync android
        
    - name: ğŸ Build iOS release
      run: xcodebuild -workspace ios/App/App.xcworkspace -scheme App -configuration Release -destination generic/platform=iOS build
      
    - name: ğŸ¤– Build Android release
      run: |
        cd android
        ./gradlew assembleRelease
        
    - name: ğŸ’¾ Archive release builds
      uses: actions/upload-artifact@v4
      with:
        name: release-builds
        path: |
          ios/
          android/app/build/outputs/apk/release/